<#
.NAME
    Resolve-CVE-2020-0796


.SYNOPSIS
    This cmdlet is meant to mitigate any Windows Operating systems vulnerable to CVE-2020-0796.
    It checks the OS version to determine whether or not a change is neccessary. If a system is
    vulnerable this cmdlet will make the recommended actions as suggested by Microsoft. This
    workaround provided by Microsoft is only effecitive on SMBv3 servers not SMBv3 Clients.


.SYNTAX
    Resolve-CVE-2020-0796 [[-ComputerName] <string[]>] [-Undo] [<CommonParameters>]


.PARAMETER ComputerName
    Specifies one or more computers. The default is the local computer.

    Type the NETBIOS name, an IP address, or a fully qualified domain name of a remote computer. To specify the
    local computer, type the computer name, a dot (.), or localhost.

    This parameter does not rely on Windows PowerShell remoting. You can use the ComputerName parameter even if
    your computer is not configured to run remote commands.

.PARAMETER Undo
    Specify this switch parameter if you want to undo the changes this function makes to the registry.
    This will re-enable SMB v3.1.1 Compression in Windows version 1903 and 1909.


.DESCRIPTION
    A remote code execution vulnerability exists in the way that the Microsoft Server Message Block
    3.1.1 (SMBv3) protocol handles certain requests. An attacker who successfully exploited the
    vulnerability could gain the ability to execute code on the target server or client. To
    exploit the vulnerability against a server, an unauthenticated attacker could send a specially
    crafted packet to a targeted SMBv3 server. To exploit the vulnerability against a client, an
    unauthenticated attacker would need to configure a malicious SMBv3 server and convince a user
    to connect to it. The security update addresses the vulnerability by correcting how the SMBv3
    protocol handles these specially crafted requests. Resolve-CVE-2020-0796 makes the Microsoft
    recommended changes to the registry in order to provide a workaround for the vulnerability on
    Windows Servers version 1903 and 1909.


.EXAMPLE
.EXAMPLE 1
    PS> Resolve-CVE-2020-0796

.EXAMPLE 2
    PS> Resolve-CVE-2020-0796 -ComputerName "DESK01", "DESK02"

.EXAMPLE 3
    PS> Get-ADComputer -Filter 'Name -like "DESK*"' | Resolve-CVE-2020-0796
    PS> Resolve-CVE-2020-0796

.EXAMPLE 4
    PS> Resolve-CVE-2020-0796 -Undo

.EXAMPLE 5
    PS> Resolve-CVE-2020-0796 -ComputerName "DESK05" -Undo

.LINK
    https://nvd.nist.gov/vuln/detail/CVE-2020-0796
    https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-0796
    https://support.microsoft.com/en-us/help/3185535/preventing-smb-traffic-from-lateral-connections
    https://roberthosborne.com
    https://osbornepro.com
    https://github.com/tobor88
    https://gitlab.com/tobor88
    https://www.powershellgallery.com/profiles/tobor


.INPUTS
    System.String
        You can pipe computer names to this cmdlet..

        In Windows PowerShell 2.0, the ComputerName parameter takes input from the pipeline only by property name. In
        Windows PowerShell 3.0, the ComputerName parameter takes input from the pipeline by value.


.OUTPUTS
    None

#>
Function Resolve-CVE-2020-0796 {
    [CmdletBinding()]
        param(
            [Parameter(
                Mandatory=$False,
                Position=0,
                ValueFromPipeline=$True,
                ValueFromPipelineByPropertyName=$False,
                HelpMessage="Enter the FQDN, hostname, or IPv4 address of the computer(s) you wish to check for and mitigate CVE-202-0796 of")]  # End Parameter
            [Alias('c','cn','Computer','Name','DisplayName','IPAddress','IP')]
            [String[]]$ComputerName,

            [Parameter(
                Mandatory=$False)]  # End Parameter
            [Switch][Bool]$Undo)  # End param

BEGIN
{

    If ($PSBoundParameters.ContainsKey('Undo'))
    {

        $Value = 0

    }  # End If
    Else
    {

        $Value = 1

    }  # End Else

    Write-Verbose "[*] Registry value 'DisableCompression' will be set to $Value"

}  # End BEGIN
PROCESS
{

    ForEach ($Comp in $ComputerName)
    {

        Invoke-Command -ComputerName $Comp -ScriptBlock {
            $Value = $args[0]
            $OSVersion = Get-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion" -Name ReleaseId
            If (($OSVersion.ReleaseId -match '1909') -or ($OSVersion.ReleaseId -match '1903'))
            {

                Write-Output "[!] The version of Windows on $env:COMPUTERNAME is vulnerable to CVE-2020-0796"
                $Value
                $Value.GetType()
                If ($Value -eq 0)
                {

                    Write-Warning "[!] -Undo Parameter was specified. Undoing Microsoft recommended workaround for CVE-2020-0796."
                    Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters" DisableCompression -Type DWORD -Value $Value -Force

                    Write-Verbose "[*] Verifying the change has been made"
                    If (0 -eq (Get-ItemPropertyValue -Path "HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters" -Name "DisableCompression"))
                    {

                        Write-Output "[*] SUCCESS: Registry value has been successfully returned to it's original value. No reboot is required"

                    }  # End If
                    Else
                    {

                        Throw "[x] ERROR: Registry value has not been successfully modified. Open PowerShell as an Administrtaor and try again"

                    }  # End Else

                }
                ElseIf ($Value -eq 1)
                {
                    $Value -eq 1
                    Write-Verbose "[*] Disabling compression to block unauthenticated attackers from exploiting CVE-2020-0796 against an SMBv3 Server"
                    Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters" DisableCompression -Type DWORD -Value $Value -Force

                    Write-Verbose "[*] Verifying the change has been made"
                    If (1 -eq (Get-ItemPropertyValue -Path "HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters" -Name "DisableCompression"))
                    {

                        Write-Output "[*] SUCCESS: Registry value has been successfully modified to prevent CVE-2020-0796. No reboot is required`n[]"
                        Write-Output "[i] SMB Compression is not yet used by Windows or Windows Server, and disabling SMB Compression has no negative performance impact."
                        Write-Output "[i] This workaround does not prevent exploitation of SMB clients. Follow Microsofts other guidelines if needed."
                        Write-Output "[i] MICROSOFT GUIDELINES FOR SMB CLEINTS: https://support.microsoft.com/en-us/help/3185535/preventing-smb-traffic-from-lateral-connections"

                    }  # End If
                    Else
                    {

                        Throw "[x] ERROR: Registry value has not been successfully modified. Open PowerShell as an Administrtaor and try again"

                    }  # End Else

                }  # End ElseIf

            }  # End If
            Else
            {

                Write-Output "[*] This version of Windows is not vulnerable to CVE-2020-0796"
                Exit

            }  # End Else

        }  -ArgumentList $Value # End Invoke-Command ScriptBlock

    }  # End ForEach

}  # End PROCESS

}  # End Function Resolve-CVE-2020-0796
